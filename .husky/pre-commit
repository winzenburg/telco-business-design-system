#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit validation..."

# Check for border-default usage (CRITICAL)
echo "ğŸš« Checking for deprecated border-default usage..."
if grep -r "ds-color-border-default" src/components/ui --include="*.tsx" --quiet; then
  echo "âŒ Found usage of deprecated --ds-color-border-default!"
  echo "   Run: grep -r 'ds-color-border-default' src/components/ui --include='*.tsx'"
  echo "   Fix: Form inputs â†’ use --ds-color-neutral-400"
  echo "        Structural â†’ use --ds-color-neutral-300"
  exit 1
fi

# Run token validation (fastest check)
echo "ğŸ¨ Validating design tokens..."
npm run validate:tokens
if [ $? -ne 0 ]; then
  echo "âŒ Token validation failed! Fix hard-coded colors and pixel values."
  exit 1
fi

# Run TypeScript type check
echo "ğŸ“˜ Running TypeScript checks..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript validation failed! Fix type errors before committing."
  exit 1
fi

# Run ESLint to catch any other issues
echo "ğŸ“ Running ESLint..."
npm run lint --silent
if [ $? -ne 0 ]; then
  echo "âŒ ESLint validation failed! Run 'npm run lint' to see details."
  exit 1
fi

# Quick Storybook build check (catch circular refs early)
echo "ğŸ“š Checking for circular references..."
npm run build:storybook --quiet 2>&1 | grep -i "circular\|error" > /dev/null
if [ $? -eq 0 ]; then
  echo "âš ï¸  Warning: Potential issues detected in Storybook build"
  echo "   Run 'npm run build:storybook' to see details"
fi

# Run comprehensive acceptance criteria validation
echo "ğŸ¯ Validating acceptance criteria..."
npm run validate:acceptance-criteria

echo "âœ… Pre-commit validation complete!"